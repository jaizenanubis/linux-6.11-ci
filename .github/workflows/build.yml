name: Build Linux Kernel 6.11

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install base build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential fakeroot libncurses-dev \
            bison flex libssl-dev libelf-dev dwarves bc ccache dh-python wget

      - name: Install debhelper-compat 12
        run: |
          set -e
          if wget -q http://archive.ubuntu.com/ubuntu/pool/main/d/debhelper/debhelper-compat_12.10ubuntu1_all.deb -O debhelper-compat_12.10ubuntu1_all.deb \
             || wget -q http://old-releases.ubuntu.com/ubuntu/pool/main/d/debhelper/debhelper-compat_12.10ubuntu1_all.deb -O debhelper-compat_12.10ubuntu1_all.deb; then
            sudo dpkg -i debhelper-compat_12.10ubuntu1_all.deb || sudo apt -f install -y
            echo "Installed debhelper-compat from direct .deb"
            exit 0
          fi

          WORKDIR=$(mktemp -d)
          cd "$WORKDIR"
          CANDIDATES=(
            "http://archive.ubuntu.com/ubuntu/pool/main/d/debhelper/debhelper_13.14.1ubuntu5_all.deb"
            "http://ftp.debian.org/debian/pool/main/d/debhelper/debhelper_12.10_all.deb"
            "http://archive.ubuntu.com/ubuntu/pool/main/d/debhelper/debhelper_12.10_all.deb"
          )
          for url in "${CANDIDATES[@]}"; do
            if wget -q "$url" -O debhelper-full.deb; then break; else rm -f debhelper-full.deb; fi
          done
          if [ ! -f debhelper-full.deb ]; then echo "Failed to download a debhelper package"; exit 1; fi
          dpkg-deb -x debhelper-full.deb extracted
          COMPAT_FILE=extracted/usr/share/debhelper/compat
          if [ ! -f "$COMPAT_FILE" ]; then echo "compat file not found"; exit 1; fi
          PKGDIR=pkg
          mkdir -p "$PKGDIR/DEBIAN" "$PKGDIR/usr/share/debhelper"
          cat > "$PKGDIR/DEBIAN/control" <<CONTROL_EOF
Package: debhelper-compat-12
Version: 12.10ubuntu1
Architecture: all
Maintainer: CI <ci@example.com>
Description: Compatibility level 12 for debhelper
 This package provides only the debhelper-compat file set to level 12.
CONTROL_EOF
          cp "$COMPAT_FILE" "$PKGDIR/usr/share/debhelper/compat"
          dpkg-deb --build "$PKGDIR" debhelper-compat-12_12.10ubuntu1_all.deb
          sudo dpkg -i debhelper-compat-12_12.10ubuntu1_all.deb || sudo apt -f install -y
          cd /
          rm -rf "$WORKDIR"
          echo "Installed debhelper-compat via fallback package"

      - name: Download Linux 6.11 source
        run: |
          wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.11.tar.xz
          tar -xf linux-6.11.tar.xz
          mv linux-6.11 kernel

      - name: Copy config
        run: |
          cp .config kernel/.config

      - name: Prepare config
        run: |
          cd kernel
          make olddefconfig

      - name: Build kernel
        run: |
          cd kernel
          make -j"$(nproc)"

      - name: Build Debian packages
        run: |
          cd kernel
          make bindeb-pkg -j"$(nproc)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-debs
          path: |
            *.deb
            *.changes
            *.buildinfo
